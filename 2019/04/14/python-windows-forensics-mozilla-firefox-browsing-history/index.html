<!doctype html>
<head>
	<meta name="description" content="" />
	<meta name="robots" content="index, follow" />
	<meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
	<meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
	<link rel="canonical" href="https://mattcasmith.net/2019/04/14/python-windows-forensics-mozilla-firefox-browsing-history/" />
	<meta property="og:locale" content="en_GB" />
	<meta property="og:type" content="article" />
	<meta property="og:title" content="Python tools for Windows forensics: Mozilla Firefox browsing history | MattCASmith" />
	<meta property="og:description" content="" />
	<meta property="og:url" content="https://mattcasmith.net/2019/04/14/python-windows-forensics-mozilla-firefox-browsing-history/" />
	<meta property="og:site_name" content="MattCASmith" />
	<meta property="article:published_time" content="2020-05-02T11:05:40+00:00" />
	<meta property="og:image" content="https://mattcasmith.net/wp-content/uploads/2019/04/firefox-CC.jpg" />
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:creator" content="@mattcasmith" />
	<meta name="twitter:site" content="@mattcasmith" />
</head>
	<head>
		<style>
			html {
				display: none;
			}
		</style>
		<title>Python tools for Windows forensics: Mozilla Firefox browsing history | MattCASmith</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="shortcut icon" href="/assets/images/favicon.png">
		<link rel="stylesheet" href="/assets/css/styles.css">
		<link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
		
	</head>
	
	<body>
		<div id="site-container" class="post">
		<div id="header">
			<div id="header_left">
				<a href="/"><img class="site_logo light" src="/assets/images/mcas_site_logo.png"></a>
				<a href="/"><img class="site_logo dark" src="/assets/images/mcas_site_logo_dark.png"></a>
				<a href="/"><h2>MattCASmith</h2></a>
			</div>
			<div id="header_right">
				<a target="_blank" href="https://twitter.com/mattcasmith"><img class="link_icon_twitter" src="/assets/images/twitter_icon.png"></a>
				<a target="_blank" href="mailto:mattcasmith@protonmail.com"><img class="link_icon_email light" src="/assets/images/email_icon.png"></a>
				<a target="_blank" href="mailto:mattcasmith@protonmail.com"><img class="link_icon_email dark" src="/assets/images/email_icon_dark.png"></a>
			</div>
		</div>
		
		<div class="title">
			<h1 class="entry-title">Python tools for Windows forensics: Mozilla Firefox browsing history</h1>
		</div>
		
		<div class="meta">
			<span class="year_label">2019-04-14</span>&nbsp; 
				
				
					<a href="/category/cyber-security.html">Cyber Security</a>,&nbsp;&nbsp;
				
					<a href="/category/programming.html">Programming</a>
				
			
		</div>
		
		<p>After extracting data from Google Chrome last month, next on our journey into the eye-opening world of Windows forensics it’s time to retrieve the user’s Firefox history to see which websites they’ve been visiting in Mozilla’s browser.<!--more--></p>

<h3 id="what-is-the-firefox-history-and-how-does-it-help-our-investigation">What is the Firefox history and how does it help our investigation?</h3>

<p>I’m sure everyone’s familiar with what an internet browser history is and what it shows – and if you’re not then maybe try reading <a href="https://mattcasmith.net/2019/02/15/python-windows-forensics-google-chrome-history/" target="_blank" rel="noopener noreferrer">my guide to extracting a user’s Google Chrome history</a>.</p>

<p>Firefox’s history data can be found in a file called <code class="language-plaintext highlighter-rouge">places.sqlite</code>, which is stored in the user’s directory under <code class="language-plaintext highlighter-rouge">\AppData\Roaming\Mozilla\Firefox\Profiles\</code> in the folder corresponding to the user’s Firefox profile. As the filename extension suggests, this file is in the SQLite format, meaning we’ll need to use a special Python library and <a href="https://mattcasmith.net/tag/sql" target="_blank" rel="noopener noreferrer">SQL-style commands</a> to parse it.</p>

<h3 id="setting-things-up">Setting things up</h3>

<p>Like <a href="https://mattcasmith.net/tag/windows-forensic-gatherer/" target="_blank" rel="noopener noreferrer">the other MCAS Windows Forensic Gatherer modules</a>, the Firefox history function relies on information entered by the analyst at the start of the main script, so we’ll need to pull this in.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="k">global</span> <span class="n">windows_drive</span>
<span class="k">global</span> <span class="n">username</span>
<span class="n">firefox_directory</span> <span class="o">=</span> <span class="n">windows_drive</span> <span class="o">+</span> <span class="s">":\Users</span><span class="se">\\</span><span class="s">"</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s">"\AppData\Roaming\Mozilla\Firefox\Profiles</span><span class="se">\\</span><span class="s">"</span>
<span class="k">print</span> <span class="s">"Accessing Firefox browsing history."</span></code></pre></figure>

<p>First we import <code class="language-plaintext highlighter-rouge">sqlite3</code>, which is a Python library that will allow us to manipulate the SQLite database. Then we import the global variables <code class="language-plaintext highlighter-rouge">windows_drive</code> and <code class="language-plaintext highlighter-rouge">username</code>, which contain the Windows drive letter and the subject’s username respectively. These are then used to generate the path to the Firefox <code class="language-plaintext highlighter-rouge">Profiles</code> folder and assign it to the <code class="language-plaintext highlighter-rouge">firefox_directory</code> variable.</p>

<h3 id="iterating-through-the-users-firefox-profiles">Iterating through the user’s Firefox profiles</h3>

<p>Within the <code class="language-plaintext highlighter-rouge">Profiles</code> directory there may be several different profile directories. So first we’ll identify them and iterate through them so we can extract the history data from each.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">firefox_profiles</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">firefox_directory</span><span class="p">)</span>
<span class="k">for</span> <span class="n">profile</span> <span class="ow">in</span> <span class="n">firefox_profiles</span><span class="p">:</span>
    <span class="n">database_file</span> <span class="o">=</span> <span class="n">windows_drive</span> <span class="o">+</span> <span class="s">":\Users</span><span class="se">\\</span><span class="s">"</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s">"\AppData\Roaming\Mozilla\Firefox\Profiles</span><span class="se">\\</span><span class="s">"</span> <span class="o">+</span> <span class="n">profile</span> <span class="o">+</span> <span class="s">"\places.sqlite"</span></code></pre></figure>

<p>The <code class="language-plaintext highlighter-rouge">os</code> library’s <code class="language-plaintext highlighter-rouge">listdir</code> function generates a list of all folders within the <code class="language-plaintext highlighter-rouge">Profiles</code> directory and assigns it to the <code class="language-plaintext highlighter-rouge">firefox_profiles</code> variable. Then for each of these profiles we generate the full path of the <code class="language-plaintext highlighter-rouge">places.sqlite</code> file and assign it to <code class="language-plaintext highlighter-rouge">database_file</code>.</p>

<h3 id="fetching-urls-and-visit-data">Fetching URLs and visit data</h3>

<p>There are several tables within the <code class="language-plaintext highlighter-rouge">places.sqlite</code> database – including one containing visited URLs and one containing visit metadata – so we need to extract the data from each separately and match them to each other. We’ll start by grabbing the list of visited URLs.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">database_file</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"SELECT * from moz_places"</span><span class="p">)</span>
    <span class="n">url_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">cursor</span><span class="p">.</span><span class="n">fetchall</span><span class="p">())</span></code></pre></figure>

<p>We use <code class="language-plaintext highlighter-rouge">sqlite3</code> to access the database file and select every record from the table <code class="language-plaintext highlighter-rouge">moz_places</code>. This data is assigned to the <code class="language-plaintext highlighter-rouge">url_data</code> variable. Next we need the visit metadata.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">database_file</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"SELECT * from moz_historyvisits"</span><span class="p">)</span>
    <span class="n">browsing_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">cursor</span><span class="p">.</span><span class="n">fetchall</span><span class="p">())</span></code></pre></figure>

<p>The method is much the same. We select every record from the <code class="language-plaintext highlighter-rouge">moz_historyvisits</code> table and store them in the <code class="language-plaintext highlighter-rouge">browsing_data</code> variable. Now we need to match the two together.</p>

<h3 id="combining-the-browsing-data">Combining the browsing data</h3>

<p>If we take a look at the data in <code class="language-plaintext highlighter-rouge">browsing_data</code> and <code class="language-plaintext highlighter-rouge">url_data</code>, we can see they share a unique identifier. This is the third value in each <code class="language-plaintext highlighter-rouge">browsing_data</code> record and the first in each <code class="language-plaintext highlighter-rouge">url_data</code> record.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">browsing_data</span><span class="p">:</span>
        <span class="n">url_reference</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">saved_url</span> <span class="ow">in</span> <span class="n">url_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">saved_url</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">url_reference</span><span class="p">:</span>
                <span class="n">visit_url</span> <span class="o">=</span> <span class="n">saved_url</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></code></pre></figure>

<p>We iterate through each of the <code class="language-plaintext highlighter-rouge">browsing_data</code> records and extract the third value (<code class="language-plaintext highlighter-rouge">record[2]</code>). Then we iterate through each of the records in <code class="language-plaintext highlighter-rouge">url_data</code> to look for a matching identifier in <code class="language-plaintext highlighter-rouge">saved_url[0]</code>. If the two values match then we save the actual URL (<code class="language-plaintext highlighter-rouge">saved_url[1]</code>) to <code class="language-plaintext highlighter-rouge">visit_url</code>.</p>

<p>Now that we have a matching URL and metadata record, we need to extract the relevant timestamp and convert it to the same format as the rest of our CSV timeline.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">visit_time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">datetime</span><span class="p">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">microseconds</span><span class="o">=</span><span class="n">record</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">visit_time</span> <span class="o">=</span> <span class="n">visit_time</span><span class="p">[:</span><span class="o">-</span><span class="mi">7</span><span class="p">]</span></code></pre></figure>

<p>First we grab the timestamp from <code class="language-plaintext highlighter-rouge">record[3]</code> and convert the time delta to the correct format with <code class="language-plaintext highlighter-rouge">datetime</code>. It is converted to a string with <code class="language-plaintext highlighter-rouge">str</code>, stored in the <code class="language-plaintext highlighter-rouge">visit_time</code> variable, and trimmed to the right length so it will match the CSV timeline entries created by our other forensic modules.</p>

<h3 id="writing-the-results-to-the-csv-timeline">Writing the results to the CSV timeline</h3>

<p>Our final task is to assemble each Firefox history record into a line that matches our timeline and append it to the output CSV file with the rest of the gathered data.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">visit_line</span> <span class="o">=</span> <span class="n">visit_time</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="s">"Website visited (Firefox)"</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="n">visit_url</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="n">visit_time</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="s">"Firefox history"</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="n">profile</span> <span class="o">+</span> <span class="s">"\places.sqlite"</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
        <span class="n">timeline_csv</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">visit_line</span><span class="p">)</span>
<span class="k">print</span> <span class="s">"Firefox browsing history gathered."</span>
<span class="k">print</span> <span class="s">""</span></code></pre></figure>

<p>We combine the visit time, URL, username, and – importantly – the name of the Firefox profile the data was retrieved from into a line and add it to the CSV file. Then, once all the data has been added, we write a confirmation message to the screen to let the analyst know the module finished successfully.</p>

<h3 id="the-output">The output</h3>

<p>Like every month, we’ll filter our events to see what’s been added to the timeline – and as you can see below, we now have a list of websites visited with Mozilla Firefox.</p>

<p><a href="/wp-content/uploads/2019/04/firefox_history_forensics.png"><img src="/wp-content/uploads/2019/04/firefox_history_forensics.png" /></a></p>

<p>These Firefox visits now join <a href="https://mattcasmith.net/2018/11/23/python-forensics-tools-windows-prefetch/" target="_blank" rel="noopener noreferrer">Prefetch data</a>, <a href="https://mattcasmith.net/2018/12/15/python-windows-forensics-recycle-bin-deleted-files/" target="_blank" rel="noopener noreferrer">deleted files</a>, <a href="https://mattcasmith.net/2019/01/18/python-windows-forensics-security-event-log/" target="_blank" rel="noopener noreferrer">logons and logoffs</a>, <a href="https://mattcasmith.net/2019/03/15/python-windows-forensics-microsoft-office-recent-files/" target="_blank" rel="noopener noreferrer">recently accessed Microsoft Office files</a>, and <a href="https://mattcasmith.net/2019/02/15/python-windows-forensics-google-chrome-history/" target="_blank" rel="noopener noreferrer">Google Chrome website visits</a> in our forensic timeline.</p>

<p>Next month, we’ll take a look at how to record active network connections on the system. Until then, head to <a href="https://mattcasmith.net/tag/windows-forensic-gatherer/" target="_blank" rel="noopener noreferrer">the MCAS Windows Forensic Gatherer page</a> if you missed any other posts in the series.</p>

<p><em>Photo © <a href="https://www.flickr.com/photos/jeanmarcalbert/10714240756/" target="_blank" rel="noopener noreferrer">Jean-Marc Albert</a> (<a href="https://creativecommons.org/licenses/by-sa/2.0/" target="_blank" rel="noopener noreferrer">CC BY-SA 2.0</a>). Cropped.</em></p>

		
		<div id="cta">
	Looking for the comments? My website doesn't have a comments section because it would take a fair amount of effort to maintain and wouldn't usually present much value to readers. However, if you have thoughts to share I'd love to hear from you - feel free to send me <a href="https://twitter.com/mattcasmith" target="_blank">a tweet</a> or <a href="mailto:mattcasmith@protonmail.com">an email</a>.
</div>
		
		<div id="prev_next">
			<div class="prev">
				    
						<a href="/2019/04/07/investigate-network-connections-netstat/">&laquo;&nbsp;Investigating external network connections with netstat and OSINT</a>
					
			</div>
			<div class="next">
				    
						<a href="/2019/04/21/twitch-streamer-tech-support-scammers/">The Twitch streamer who wastes tech support scammers&#8217; time&nbsp;&raquo;</a>
					
			</div>
		</div>
		
		
				<div id="footer">
			&copy; 2016-21 MattCASmith
			<span class="home-link">Personal blog - does not reflect views of employers past or present</span>
		</div>
		
		<script data-goatcounter="https://mattcasmith.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
		
		</div>
	
	</body>
</html>