<!doctype html>
<head>
	<meta name="description" content="" />
	<meta name="robots" content="index, follow" />
	<meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
	<meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
	<link rel="canonical" href="https://mattcasmith.net/2018/04/08/incident-triage-identifying-the-source-of-a-malware-infection/" />
	<meta property="og:locale" content="en_GB" />
	<meta property="og:type" content="article" />
	<meta property="og:title" content="Incident triage: Identifying the source of a malware infection | MattCASmith" />
	<meta property="og:description" content="" />
	<meta property="og:url" content="https://mattcasmith.net/2018/04/08/incident-triage-identifying-the-source-of-a-malware-infection/" />
	<meta property="og:site_name" content="MattCASmith" />
	<meta property="article:published_time" content="2020-05-02T11:05:40+00:00" />
	<meta property="og:image" content="https://mattcasmith.net/wp-content/uploads/2018/04/needlehaystack.jpg" />
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:creator" content="@mattcasmith" />
	<meta name="twitter:site" content="@mattcasmith" />
</head>
	<head>
		<style>
			html {
				display: none;
			}
		</style>
		<title>Incident triage: Identifying the source of a malware infection | MattCASmith</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="shortcut icon" href="/assets/images/favicon.png">
		<link rel="stylesheet" href="/assets/css/styles.css">
		<link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
		
	</head>
	
	<body>
		<div id="site-container" class="post">
		<div id="header">
			<div id="header_left">
				<a href="/"><img class="site_logo light" src="/assets/images/mcas_site_logo.png"></a>
				<a href="/"><img class="site_logo dark" src="/assets/images/mcas_site_logo_dark.png"></a>
				<a href="/"><h2>MattCASmith</h2></a>
			</div>
			<div id="header_right">
				<a target="_blank" href="https://twitter.com/mattcasmith"><img class="link_icon_twitter" src="/assets/images/twitter_icon.png"></a>
				<a target="_blank" href="mailto:mattcasmith@protonmail.com"><img class="link_icon_email light" src="/assets/images/email_icon.png"></a>
				<a target="_blank" href="mailto:mattcasmith@protonmail.com"><img class="link_icon_email dark" src="/assets/images/email_icon_dark.png"></a>
			</div>
		</div>
		
		<div class="title">
			<h1 class="entry-title">Incident triage: Identifying the source of a malware infection</h1>
		</div>
		
		<div class="meta">
			<span class="year_label">2018-04-08</span>&nbsp; 
				
				
					<a href="/category/cyber-security.html">Cyber Security</a>
				
			
		</div>
		
		<p>Part of my time at <a href="http://mattcasmith.net/2017/03/27/finishing-line-ive-passed-my-gcih-exam/" target="_blank" rel="noopener">the SANS Cyber Retraining Academy</a> covered the incident response methodology and how to identify what’s wrong and how to fix it. But theory is quite different to the real thing, so I thought it would be useful to make a cheat sheet with a few of the pointers I’ve picked up when it comes to investigating malware activity.<!--more--></p>

<p>In many cases you’ll be responding to an alert from an anti-virus solution or an intrusion detection system. It might tell you the infected hostname, the name and directory of the suspicious file, and what kind of malware it thinks it’s found. But where do you go from there? How do you find out how it got there in the first place?</p>

<h3 id="finding-the-original-malicious-file">Finding the original malicious file</h3>

<p>Where did the malware come from? Often, the file that a security product detects won’t be the first malicious file that landed on the endpoint. But if you know the time of the first detection you can work back from this point to find the original offender.</p>

<p>With limited information available about the user’s prior actions (depending on your level of logging), I’ve found the following two directories to be a goldmine when it comes to identifying what the user was doing immediately before the malware alert.</p>

<blockquote>
  <p>[USER DIRECTORY]\AppData\Roaming\Microsoft\Windows\Recent[FILE NAME].lnk<br />
[USER DIRECTORY]\AppData\Roaming\Microsoft\Office\Recent[FILE NAME].lnk</p>
</blockquote>

<p>These folders contain shortcuts to recently opened files, so finding links that were added just before the detection can be hugely valuable. A Word document opened just before an executable was found, for example, could point to a phishing attack.</p>

<h3 id="finding-the-source-of-the-infection">Finding the source of the infection</h3>

<p>Now you’ve located the original file, it’s time to work out where it came from. Even more than the last step, this depends on the kinds of logs you have available to work with.</p>

<p>The most useful logs here are often web proxy or DNS logs, which can show the domains and/or URLs that the infected user accessed before the file was downloaded. The most obvious indicator of compromise here is a request to a suspicious-looking URL, which can be checked out via a service like <a href="https://urlscan.io">urlscan.io</a> or <a href="https://exchange.xforce.ibmcloud.com/" target="_blank" rel="noopener">IBM X-Force Exchange</a>.</p>

<p>The other potential clue – albeit a less reliable one – is a request to an email service prior to the malware detection. This could be a sign that the user was tricked into downloading and opening a malicious email attachment and was infected that way.</p>

<p>The next most common attack vector is probably infection via USB stick or portable hard drive, which you may be able to identify based on the directory of the executables that were run if you have access to application activity logs.</p>

<p>These techniques won’t work every time – the variety of malware and delivery methods out there is simply too wide – but I’ve found them to be a useful starting point in tracking down what’s going wrong. I’ve also recently identified a few places to look to determine if the malware has established persistence, but that’s a story for another blog post…</p>

<p><em>Photo from <a href="https://pixabay.com/en/needle-hay-needle-in-a-haystack-1419606/" target="_blank" rel="noopener">Pixabay</a> (<a href="https://creativecommons.org/share-your-work/public-domain/cc0/" target="_blank" rel="noopener">CC0</a>). Cropped.</em></p>

		
		<div id="cta">
	Looking for the comments? My website doesn't have a comments section because it would take a fair amount of effort to maintain and wouldn't usually present much value to readers. However, if you have thoughts to share I'd love to hear from you - feel free to send me <a href="https://twitter.com/mattcasmith" target="_blank">a tweet</a> or <a href="mailto:mattcasmith@protonmail.com">an email</a>.
</div>
		
		<div id="prev_next">
			<div class="prev">
				    
						<a href="/2018/03/17/here-are-some-of-the-best-things-i-did-saw-and-ate-in-japan/">&laquo;&nbsp;Here are some of the best things I did, saw and ate in Japan</a>
					
			</div>
			<div class="next">
				    
						<a href="/2018/04/29/automatically-generating-soc-emails-with-a-python-script/">Automatically generating SOC emails with a Python script&nbsp;&raquo;</a>
					
			</div>
		</div>
		
		
				<div id="footer">
			&copy; 2016-21 MattCASmith
			<span class="home-link">Personal blog - does not reflect views of employers past or present</span>
		</div>
		
		<script data-goatcounter="https://mattcasmith.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
		
		</div>
	
	</body>
</html>